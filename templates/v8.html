<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>V8 Sistema - Multi Tech</title>

    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/logo.png') }}">

    <style>
        .card {
            background: var(--bg-container);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 25px;
            width: 100%;
            max-width: 1100px;
            color: var(--cor-texto);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25);
        }

        h2 {
            font-size: 26px;
            margin-bottom: 18px;
            font-weight: 600;
        }

        .linha {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .col {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        input,
        select {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            background: var(--bg-input);
            color: var(--cor-texto);
            font-size: 15px;
        }

        input:focus {
            outline: 2px solid #00ff88;
        }

        .btn {
            margin-top: 10px;
            padding: 12px 18px;
            border-radius: 10px;
            cursor: pointer;
            border: none;
            font-weight: bold;
            transition: 0.3s;
        }

        .btn:hover {
            transform: scale(1.04);
        }

        .btn-acao {
            background: #0aff73;
            color: #000;
        }

        .btn-loading {
            opacity: 0.8;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 0.7s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .resultado {
            margin-top: 20px;
            padding: 18px;
            border-radius: 12px;
            background: rgba(0, 255, 153, 0.15);
            border: 2px solid #00ff88;
            font-size: 16px;
        }

        .config-card {
            background: linear-gradient(40deg, var(--gradiente-inicio), var(--gradiente-fim));
            border: 2px solid #00d47f;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            transition: 0.2s;
        }

        .config-card:hover {
            transform: scale(1.02);
            background: linear-gradient(40deg, var(--gradiente-inicio), var(--gradiente-fim));
            color: var(--cor-texto);
        }

        .config-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--cor-texto);
        }

        .simulacao-item {
            padding: 10px 0;
            border-bottom: 1px solid #00ff88;
        }

        .simulacao-item:last-child {
            border-bottom: none;
        }

        select option {
            background-color: #062408 !important;
            color: #ffffff !important;
        }
    </style>
</head>

<script src="/static/js/theme.js"></script>

<body class="pagina">
    <div class="sidebar" id="sidebar">
        <div>
            <img src="/static/img/logo.png" style="width: 110px; padding-left: 15px;">
            <div class="logo">Multi Tech</div>

            <div class="user-info">
                <h3>{{ session["user"] }}</h3>
                <span>{{ session["role"] }}</span>
            </div>

            <ul class="menu">
                <li><a href="/dashboard">‚ñ∏ Dashboard</a></li>
                <li><a href="/index">‚ñ∏ SIMPLIX</a></li>
                <li><a href="/presenca">‚ñ∏ PRESEN√áA</a></li>
                <li><a href="/c6bank">‚ñ∏ C6 BANK</a></li>
                <li><a href="/hub">‚ñ∏ HUB Cr√©dito</a></li>
                <li><a class="active" href="/v8">‚ñ∏ V8 Sistema</a></li>
                {% if session['role'] == 'admin' %}
                <li><a href="/usuarios">‚ñ∏ Usu√°rios</a></li>
                <li><a href="/register">‚ñ∏ Criar Usu√°rio</a></li>
                {% endif %}
            </ul>
        </div>

        <div class="menu-footer">
            <button id="toggle-theme"><i class="fa fa-moon"></i> Tema</button>
            <a href="/logout" class="logout">‚ñ∏ Sair</a>
        </div>
    </div>

    <div class="content">

        <h1 class="titulo-tomorrow">V8 Sistema</h1>

        <div class="card">
            <h2>Gerar Termo</h2>

            <div class="linha">
                <div class="col">
                    <label>CPF <span style="color:#ff4d4d;">(obrigat√≥rio)</span></label>
                    <input id="cpf" placeholder="12345678900">
                </div>

                <div class="col">
                    <label>Nome Completo <span style="color:#ff4d4d;">(obrigat√≥rio)</span></label>
                    <input id="nome">
                </div>

                <div class="col">
                    <label>Data de Nascimento <span style="color:#ff4d4d;">(obrigat√≥rio)</span></label>
                    <input type="date" id="nasc">
                </div>
            </div>

            <div class="linha">
                <div class="col">
                    <label>Sexo <span style="color:#ff4d4d;">(obrigat√≥rio)</span></label>
                    <select id="sexo">
                        <option value="male">Masculino</option>
                        <option value="female">Feminino</option>
                    </select>
                </div>

                <div class="col">
                    <label>Email <span style="color:#1f45f1f3;">(aleat√≥rio)</span></label>
                    <input id="email">
                </div>

                <div class="col">
                    <label>Telefone (DDD + N√∫mero) <span style="color:#1f45f1f3;">(aleat√≥rio)</span></label>
                    <input id="telefone" placeholder="11987654321">
                </div>
            </div>

            <button onclick="gerarTermo()" id="btnGerar" class="btn btn-acao">
                <i class="fa fa-file-signature"></i> Gerar Termo
            </button>

            <div id="resultado-termo"></div>
        </div>

        <div class="card" id="card-configs" style="display:none;">
            <h2>Configura√ß√µes Dispon√≠veis</h2>
            <div id="lista-configs"></div>
        </div>

        <div class="card" id="card-simulacao" style="display:none;">
            <h2>Simula√ß√£o</h2>

            <div class="linha">
                <div class="col">
                    <label>Valor Parcela (R$)</label>
                    <input id="parcela">
                </div>

                <div class="col">
                    <label>N¬∫ Parcelas</label>
                    <input id="numParcelas">
                </div>
            </div>

            <button onclick="simular()" class="btn btn-acao" id="btnSimular">
                <i class="fa fa-calculator"></i> Simular
            </button>

            <div id="resultado-simulacao"></div>
        </div>

        <!--  AGORA O CARD DA PROPOSTA EST√Å DENTRO DO .content  -->
        <div class="card" id="card-proposta" style="display:none;">
            <h2>Finalizar Proposta</h2>

            <div class="linha">
                <div class="col">
                    <label>Estado Civil</label>
                    <select id="marital_status">
                        <option value="single">Solteiro(a)</option>
                        <option value="married">Casado(a)</option>
                        <option value="divorced">Divorciado(a)</option>
                        <option value="widowed">Vi√∫vo(a)</option>
                    </select>
                </div>

                <div class="col">
                    <label>Nacionalidade</label>
                    <select id="nationality">
                        <option value="Brazilian">Brasileiro(a)</option>
                        <option value="Foreigner">Estrangeiro(a)</option>
                    </select>
                </div>
            </div>

            <div class="linha">
                <div class="col">
                    <label>Nome da M√£e</label>
                    <input id="mother_name">
                </div>

                <div class="col">
                    <label>Emissor do Documento</label>
                    <input id="document_issuer" placeholder="SSP-SP">
                </div>
            </div>

            <div class="linha">
                <div class="col">
                    <label>Tipo Documento</label>
                    <select id="document_type">
                        <option value="rg">RG</option>
                        <option value="cnh">CNH</option>
                    </select>
                </div>

                <div class="col">
                    <label>N√∫mero Documento</label>
                    <input id="document_number">
                </div>
            </div>

            <div class="linha">
                <div class="col">
                    <label>CEP</label>
                    <input id="postal_code" maxlength="8">
                </div>

                <div class="col">
                    <label>Cidade</label>
                    <input id="city">
                </div>

                <div class="col">
                    <label>UF</label>
                    <input id="state" maxlength="2">
                </div>
            </div>

            <div class="linha">
                <div class="col">
                    <label>Bairro</label>
                    <input id="neighborhood">
                </div>

                <div class="col">
                    <label>Rua</label>
                    <input id="street">
                </div>

                <div class="col">
                    <label>N√∫mero</label>
                    <input id="number">
                </div>
            </div>

            <div class="linha">
                <div class="col">
                    <label>Chave PIX (CPF)</label>
                    <input id="pix_key" placeholder="Somente n√∫meros">
                </div>
            </div>

            <button onclick="criarProposta()" id="btnProposta" class="btn btn-acao">
                <i class="fa fa-check-circle"></i> Criar Proposta
            </button>

            <div id="resultado-proposta"></div>
        </div>

    </div>

    <script>
        const cpfInput = document.getElementById("cpf");

        cpfInput.addEventListener("input", e => {
            let v = e.target.value.replace(/\D/g, "");
            v = v.slice(0, 11);
            e.target.value = v;
        });

        cpfInput.addEventListener("paste", e => {
            e.preventDefault();
            let txt = (e.clipboardData || window.clipboardData).getData("text");
            txt = txt.replace(/\D/g, "").slice(0, 11);
            cpfInput.value = txt;
        });

        const telInput = document.getElementById("telefone");

        telInput.addEventListener("input", e => {
            let v = e.target.value.replace(/\D/g, "");
            v = v.slice(0, 11);
            e.target.value = v;
        });

        telInput.addEventListener("paste", e => {
            e.preventDefault();
            let txt = (e.clipboardData || window.clipboardData).getData("text");
            txt = txt.replace(/\D/g, "").slice(0, 11);
            telInput.value = txt;
        });

        document.getElementById("nasc").addEventListener("paste", e => {
            e.preventDefault();
            let txt = (e.clipboardData || window.clipboardData).getData("text");

            txt = txt.replace(/\D/g, "");

            if (txt.length === 8) {
                const dia = txt.slice(0, 2);
                const mes = txt.slice(2, 4);
                const ano = txt.slice(4, 8);
                e.target.value = `${ano}-${mes}-${dia}`;
                return;
            }

            const m = (e.clipboardData || window.clipboardData)
                .getData("text")
                .match(/(\d{1,2})[\/\-\.\s]?(\d{1,2})[\/\-\.\s]?(\d{4})/);

            if (m) {
                const dia = m[1].padStart(2, "0");
                const mes = m[2].padStart(2, "0");
                const ano = m[3];
                e.target.value = `${ano}-${mes}-${dia}`;
            }
        });

        document.getElementById("postal_code").addEventListener("input", async function () {
            let cep = this.value.replace(/\D/g, "");

            if (cep.length === 8) {
                const req = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await req.json();

                if (!data.erro) {
                    document.getElementById("street").value = data.logradouro || "";
                    document.getElementById("neighborhood").value = data.bairro || "";
                    document.getElementById("city").value = data.localidade || "";
                    document.getElementById("state").value = data.uf || "";
                }
            }
        });

        async function gerarTermo() {

            const cpf = document.getElementById("cpf").value.replace(/\D/g, "");
            const tel = document.getElementById("telefone").value.replace(/\D/g, "");

            if (cpf.length !== 11) {
                alert("CPF deve conter 11 n√∫meros.");
                return;
            }

            if (tel.length < 10 || tel.length > 11) {
                alert("Telefone deve conter entre 10 e 11 n√∫meros.");
                return;
            }

            const btn = document.getElementById("btnGerar");
            btn.innerHTML = `<span class="spinner"></span> Gerando...`;
            btn.classList.add("btn-loading");

            const area = tel.slice(0, 2);
            const num = tel.slice(2);

            const payload = {
                borrowerDocumentNumber: cpf,
                gender: document.getElementById("sexo").value,
                birthDate: document.getElementById("nasc").value,
                signerName: document.getElementById("nome").value,
                signerEmail: document.getElementById("email").value,
                signerPhone: {
                    phoneNumber: num,
                    countryCode: "55",
                    areaCode: area
                },
                provider: "QI"
            };

            const req = await fetch("/api/v8/termo", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await req.json();

            btn.innerHTML = `<i class="fa fa-file-signature"></i> Gerar Termo`;
            btn.classList.remove("btn-loading");

            if (!data.id) {
                document.getElementById("resultado-termo").innerHTML =
                    `<div class='resultado'>Erro: ${JSON.stringify(data.erro)}</div>`;
                return;
            }

            document.getElementById("resultado-termo").innerHTML =
                `<div class='resultado'>Termo ID: <b>${data.id}</b> (autorizado automaticamente)</div>`;

            await new Promise(res => setTimeout(res, 2000));    

            carregarConfigs(data.id);
        }

        async function carregarConfigs(consultId) {
            const req = await fetch("/api/v8/configs", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ consult_id: consultId })
            });

            const data = await req.json();

            window.v8ConsultID = data.consult_id;

            let html = "";

            data.configs.forEach(c => {
                const taxa = (Number(c.monthly_interest_rate) * 100).toFixed(2).replace('.', ',');

                html += `
                <div class="config-card" onclick='selecionarConfig(${JSON.stringify(c)})'>
                    <div class="config-title">${c.slug}</div>
                    <div>Taxa mensal: <b>${taxa}%</b></div>
                    <div>Parcelas dispon√≠veis: <b>${c.number_of_installments.join(", ")}</b></div>
                </div>
            `;
            });

            document.getElementById("lista-configs").innerHTML = html;
            document.getElementById("card-configs").style.display = "block";
        }

        function selecionarConfig(cfg) {
            window.v8Config = cfg;
            document.getElementById("card-simulacao").style.display = "block";
            document.getElementById("numParcelas").value = cfg.number_of_installments[0];
        }

        async function simular() {

            const btn = document.querySelector("#btnSimular");
            btn.innerHTML = `<span class="spinner"></span> Simulando...`;
            btn.disabled = true;

            const payload = {
                consult_id: window.v8ConsultID,
                config_id: window.v8Config.id,
                installment_face_value: Number(document.getElementById("parcela").value),
                number_of_installments: Number(document.getElementById("numParcelas").value),
                provider: "QI"
            };

            async function tentarSimulacao(tentativa = 1) {

                const req = await fetch("/api/v8/simular", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const d = await req.json();

                if (d.type === "simulation_consult_not_finished") {

                    if (tentativa >= 25) {
                        document.getElementById("resultado-simulacao").innerHTML =
                            `<div class='resultado'>‚ùå N√£o finalizou a tempo. Tente novamente.</div>`;
                        btn.innerHTML = `<i class="fa fa-calculator"></i> Simular`;
                        btn.disabled = false;
                        return;
                    }

                    await new Promise(res => setTimeout(res, 5000));
                    return tentarSimulacao(tentativa + 1);
                }

                const fmt = v => Number(v).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
                const pct = v => (Number(v) * 100).toFixed(2).replace('.', ',') + "%";

                let html = `
                <div class="resultado">
                    <div class="simulacao-item"><b>Parcela:</b> ${fmt(d.installment_value)}</div>
                    <div class="simulacao-item"><b>N¬∫ Parcelas:</b> ${d.number_of_installments}</div>
                    <div class="simulacao-item"><b>Total Financiado:</b> ${fmt(d.operation_amount)}</div>
                    <div class="simulacao-item"><b>Liberado:</b> ${fmt(d.disbursement_amount)}</div>
                    <div class="simulacao-item"><b>Valor de Emiss√£o:</b> ${fmt(d.issue_amount)}</div>
                    <div class="simulacao-item"><b>IOF:</b> ${fmt(d.iof_amount)}</div>
                    ${d.insurance_amount ? `<div class="simulacao-item"><b>Seguro:</b> ${fmt(d.insurance_amount)}</div>` : ""}
                    <div class="simulacao-item"><b>Taxa Mensal:</b> ${pct(d.monthly_interest_rate)}</div>
                    <div class="simulacao-item"><b>1¬™ Parcela:</b> ${d.first_installment_date.split("-").reverse().join("/")}</div>
                    <div class="simulacao-item"><b>Produto:</b> ${d.simulation_config_slug}</div>
                </div>`;

                mostrarCardProposta();
                window.v8SimulationID = d.id_simulation;

                btn.innerHTML = `<i class="fa fa-calculator"></i> Simular`;
                btn.disabled = false;

                document.getElementById("resultado-simulacao").innerHTML = html;
            }

            tentarSimulacao();
        }

        function mostrarCardProposta() {
            document.getElementById("card-proposta").style.display = "block";
        }

        async function criarProposta() {

            const btn = document.getElementById("btnProposta");
            btn.innerHTML = `<span class="spinner"></span> Enviando...`;
            btn.disabled = true;

            const cpf = document.getElementById("cpf").value.replace(/\D/g, "");
            const tel = document.getElementById("telefone").value.replace(/\D/g, "");
            const area = tel.slice(0, 2);
            const num = tel.slice(2);

            const payload = {
                borrower: {
                    name: document.getElementById("nome").value,
                    email: document.getElementById("email").value,
                    phone: {
                        area_code: area,
                        country_code: "55",
                        number: num
                    },
                    political_exposition: false,

                    address: {
                        city: document.getElementById("city").value,
                        state: document.getElementById("state").value.toUpperCase(),
                        number: document.getElementById("number").value,
                        street: document.getElementById("street").value,
                        complement: "",
                        postal_code: document.getElementById("postal_code").value,
                        neighborhood: document.getElementById("neighborhood").value
                    },

                    birth_date: document.getElementById("nasc").value,
                    mother_name: document.getElementById("mother_name").value,
                    nationality: document.getElementById("nationality").value,
                    document_issuer: document.getElementById("document_issuer").value,
                    gender: document.getElementById("sexo").value,
                    person_type: "natural",
                    marital_status: document.getElementById("marital_status").value,
                    individual_document_number: cpf,
                    document_identification_date: document.getElementById("nasc").value,
                    document_identification_type: document.getElementById("document_type").value,
                    document_identification_number: document.getElementById("document_number").value,

                    bank: {
                        transfer_method: "pix",
                        pix_key: document.getElementById("pix_key").value,
                        pix_key_type: "cpf"
                    }
                },

                simulation_id: window.v8SimulationID,
                provider: "QI"
            };

            const req = await fetch("/api/v8/proposta", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await req.json();

            btn.innerHTML = `<i class="fa fa-check-circle"></i> Criar Proposta`;
            btn.disabled = false;

            if (data.formalization_url) {
                document.getElementById("resultado-proposta").innerHTML =
                    `<div class='resultado' style="background:#003f1f;border:2px solid #00ff88">
            <b>Proposta criada com sucesso!</b><br>
            <a href="${data.formalization_url}" target="_blank" style="color:#00ff88;font-weight:bold;">
                üëâ Abrir Formaliza√ß√£o
            </a>
        </div>`;
                return;
            }

            let mensagem = "";

            if (data.detail) mensagem = data.detail;

            else if (data.title) mensagem = data.title;

            else mensagem = "N√£o foi poss√≠vel criar a proposta.";

            mensagem = mensagem
                .replace("Proposta N√£o Eleg√≠vel (0000).", "Proposta N√£o Eleg√≠vel.")
                .replace("Fora da Pol√≠tica de Cr√©dito", "Fora da Pol√≠tica de Cr√©dito");

            document.getElementById("resultado-proposta").innerHTML =
                `<div class='resultado' style="background:#3b0000;border:2px solid #ff4d4d;color:white;">
        ‚ùå <b>${mensagem}</b>
    </div>`;
        }
    </script>


</body>

</html>