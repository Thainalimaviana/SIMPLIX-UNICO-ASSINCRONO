<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>V8 Sistema - Multi Tech</title>

    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/logo.png') }}">

    <style>
        .card {
            background: var(--bg-container);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 25px;
            width: 100%;
            max-width: 1100px;
            color: var(--cor-texto);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25);
        }

        h2 {
            font-size: 26px;
            margin-bottom: 18px;
            font-weight: 600;
        }

        .linha {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .col {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        input,
        select {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            background: var(--bg-input);
            color: var(--cor-texto);
            font-size: 15px;
        }

        input:focus {
            outline: 2px solid #00ff88;
        }

        .btn {
            margin-top: 10px;
            padding: 12px 18px;
            border-radius: 10px;
            cursor: pointer;
            border: none;
            font-weight: bold;
            transition: 0.3s;
        }

        .btn:hover {
            transform: scale(1.04);
        }

        .btn-acao {
            background: #0aff73;
            color: #000;
        }

        .btn-loading {
            opacity: 0.8;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 0.7s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .resultado {
            margin-top: 20px;
            padding: 18px;
            border-radius: 12px;
            background: rgba(0, 255, 153, 0.15);
            border: 2px solid #00ff88;
            font-size: 16px;
        }

        .margem-card {
            background: rgba(0, 255, 88, 0.15);
            border: 2px solid #00ff88;
            padding: 18px;
            border-radius: 12px;
            margin-top: 15px;
        }

        .simulacao-item {
            padding: 10px 0;
            border-bottom: 1px solid #00ff88;
        }

        .simulacao-item:last-child {
            border-bottom: none;
        }

        .config-card {
            background: linear-gradient(40deg, var(--gradiente-inicio), var(--gradiente-fim));
            border: 2px solid #00d47f;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            transition: 0.25s ease;
            cursor: pointer;
        }

        .config-card:hover {
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(0, 255, 153, 0.3);
        }

        .config-card.selected {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(0, 255, 153, 0.55);
            border-color: #00ff99;
        }

        select {
            background: var(--bg-input);
            color: var(--cor-texto);
        }

        select::-ms-expand {
            display: none;
        }

        select option {
            background: var(--bg-input);
            color: var(--cor-texto);
        }

        select option:hover {
            background: #00ff88 !important;
            color: #000 !important;
        }

        @-moz-document url-prefix() {
            select {
                background-color: var(--bg-input);
                color: var(--cor-texto);
            }

            select option {
                background-color: var(--bg-input) !important;
                color: var(--cor-texto) !important;
            }
        }
    </style>
</head>

<script src="/static/js/theme.js"></script>

<body class="pagina">
    <div class="sidebar" id="sidebar">
        <div>
            <img src="/static/img/logo.png" style="width: 110px; padding-left: 15px;">
            <div class="logo">Multi Tech</div>

            <div class="user-info">
                <h3>{{ session["user"] }}</h3>
                <span>{{ session["role"] }}</span>
            </div>

            <ul class="menu">
                <li><a href="/dashboard">▸ Dashboard</a></li>
                <li><a href="/index">▸ SIMPLIX</a></li>
                <li><a href="/presenca">▸ PRESENÇA</a></li>
                <li><a href="/c6bank">▸ C6 BANK</a></li>
                <li><a href="/hub">▸ HUB Crédito</a></li>
                <li><a class="active" href="/v8">▸ V8 Sistema</a></li>
                {% if session['role'] == 'admin' %}
                <li><a href="/usuarios">▸ Usuários</a></li>
                <li><a href="/register">▸ Criar Usuário</a></li>
                {% endif %}
            </ul>
        </div>

        <div class="menu-footer">
            <button id="toggle-theme"><i class="fa fa-moon"></i> Tema</button>
            <a href="/logout" class="logout">▸ Sair</a>
        </div>
    </div>

    <div class="content">

        <h1 class="titulo-tomorrow">V8 Sistema</h1>

        <div class="card">
            <h2>Gerar Termo</h2>

            <div class="linha">
                <div class="col">
                    <label>CPF</label>
                    <input id="cpf" placeholder="12345678900" oninput="this.value = formatarCPF(this.value)">
                </div>

                <div class="col">
                    <label>Nome Completo</label>
                    <input id="nome">
                </div>

                <div class="col">
                    <label>Data de Nascimento</label>
                    <input type="date" id="nasc">
                </div>
            </div>

            <div class="linha">
                <div class="col">
                    <label>Sexo</label>
                    <select id="sexo">
                        <option value="male">Masculino</option>
                        <option value="female">Feminino</option>
                    </select>
                </div>

                <div class="col">
                    <label>Email</label>
                    <input id="email">
                </div>

                <div class="col">
                    <label>Telefone</label>
                    <input id="telefone" placeholder="11987654321" oninput="this.value = formatarTelefone(this.value)">
                </div>
            </div>

            <button onclick="gerarTermo()" id="btnGerar" class="btn btn-acao">
                <i class="fa fa-file-signature"></i> Gerar Termo
            </button>

            <button onclick="consultarUsuario()" id="btnConsultar" class="btn btn-acao"
                style="display:none; margin-left:10px;">
                <i class="fa fa-search"></i> Consultar Situação / Margem
            </button>

            <div id="resultado-termo"></div>
            <div id="resultado-consulta"></div>
        </div>

        <div class="card" id="card-configs" style="display:none;">
            <h2>Configurações Disponíveis</h2>
            <div id="lista-configs"></div>
        </div>

        <div class="card" id="card-simulacao" style="display:none;">
            <h2>Simulação</h2>

            <div class="linha">
                <div class="col">
                    <label>Valor da Parcela (R$)</label>
                    <input id="parcela">
                </div>

                <div class="col">
                    <label>Nº Parcelas</label>
                    <input id="numParcelas">
                </div>
            </div>

            <button onclick="simular()" id="btnSimular" class="btn btn-acao">
                <i class="fa fa-calculator"></i> Simular
            </button>

            <div id="resultado-simulacao"></div>
        </div>

        <div class="card" id="card-proposta" style="display:none;">
            <h2>Finalizar Proposta</h2>

            <div class="linha">
                <div class="col">
                    <label>Estado Civil</label>
                    <select id="marital_status">
                        <option value="single">Solteiro(a)</option>
                        <option value="married">Casado(a)</option>
                        <option value="divorced">Divorciado(a)</option>
                        <option value="widowed">Viúvo(a)</option>
                    </select>
                </div>

                <div class="col">
                    <label>Nacionalidade</label>
                    <select id="nationality">
                        <option value="Brazilian">Brasileiro(a)</option>
                        <option value="Foreigner">Estrangeiro(a)</option>
                    </select>
                </div>
            </div>

            <div class="linha">
                <div class="col">
                    <label>Nome da Mãe</label>
                    <input id="mother_name">
                </div>

                <div class="col">
                    <label>Órgão Expedidor</label>
                    <input id="document_issuer" placeholder="SSP-SP">
                </div>
            </div>

            <div class="linha">
                <div class="col">
                    <label>Tipo Doc.</label>
                    <select id="document_type">
                        <option value="rg">RG</option>
                        <option value="cnh">CNH</option>
                    </select>
                </div>

                <div class="col">
                    <label>Número Doc.</label>
                    <input id="document_number">
                </div>
            </div>

            <div class="linha">
                <div class="col">
                    <label>CEP</label>
                    <input id="postal_code" maxlength="8">
                </div>

                <div class="col">
                    <label>Cidade</label>
                    <input id="city">
                </div>

                <div class="col">
                    <label>UF</label>
                    <input id="state" maxlength="2">
                </div>
            </div>

            <div class="linha">
                <div class="col">
                    <label>Bairro</label>
                    <input id="neighborhood">
                </div>

                <div class="col">
                    <label>Rua</label>
                    <input id="street">
                </div>

                <div class="col">
                    <label>Número</label>
                    <input id="number">
                </div>
            </div>

            <div class="linha">
                <div class="col">
                    <label>PIX (CPF)</label>
                    <input id="pix_key">
                </div>
            </div>

            <button onclick="criarProposta()" id="btnProposta" class="btn btn-acao">
                <i class="fa fa-check-circle"></i> Criar Proposta
            </button>

            <div id="resultado-proposta"></div>
        </div>

    </div>

    <script>
        async function gerarTermo() {
            const btn = document.getElementById("btnGerar");
            btn.innerHTML = `<span class="spinner"></span> Gerando...`;
            btn.classList.add("btn-loading");

            const cpf = document.getElementById("cpf").value.replace(/\D/g, "");
            const tel = document.getElementById("telefone").value.replace(/\D/g, "");

            const payload = {
                borrowerDocumentNumber: cpf,
                gender: document.getElementById("sexo").value,
                birthDate: document.getElementById("nasc").value,
                signerName: document.getElementById("nome").value,
                signerEmail: document.getElementById("email").value,
                signerPhone: {
                    phoneNumber: tel.slice(2),
                    countryCode: "55",
                    areaCode: tel.slice(0, 2)
                },
                provider: "QI"
            };

            const req = await fetch("/api/v8/termo", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await req.json();

            btn.innerHTML = `<i class="fa fa-file-signature"></i> Gerar Termo`;
            btn.classList.remove("btn-loading");

            if (!data.id) {
                document.getElementById("resultado-termo").innerHTML =
                    `<div class="resultado">Erro: ${JSON.stringify(data)}</div>`;
                return;
            }

            window.v8ConsultID = data.id;

            document.getElementById("resultado-termo").innerHTML =
                `<div class="resultado">Termo criado: <b>${data.id}</b></div>`;

            document.getElementById("btnConsultar").style.display = "inline-block";
        }

        async function consultarUsuario() {
            const btn = document.getElementById("btnConsultar");
            btn.innerHTML = `<span class="spinner"></span> Consultando...`;
            btn.classList.add("btn-loading");

            const cpf = document.getElementById("cpf").value.replace(/\D/g, "");

            const req = await fetch("/api/v8/consulta", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ cpf })
            });

            const resposta = await req.json();

            btn.innerHTML = `<i class="fa fa-search"></i> Consultar Situação / Margem`;
            btn.classList.remove("btn-loading");

            if (resposta.status === 400 || resposta.detail) {
                document.getElementById("resultado-consulta").innerHTML =
                    `<div class="resultado">Situação ainda não disponível<br>
             Motivo: ${resposta.detail || "aguardando finalização"}</div>`;
                return;
            }

            if (!resposta.data || resposta.data.length === 0) {
                document.getElementById("resultado-consulta").innerHTML =
                    `<div class="resultado">Nenhum registro encontrado.</div>`;
                return;
            }

            const info = resposta.data[0];

            window.v8ConsultID = info.id;

            const margem = Number(info.availableMarginValue || 0)
                .toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

            const description = info.description ? info.description : "Nenhuma descrição";

            document.getElementById("resultado-consulta").innerHTML = `
                <div class="margem-card">
                <b>Status:</b> ${info.status}<br>
                <b>Margem Disponível:</b> ${margem}<br>
                <b>Descrição:</b> ${description}<br>
            </div>
        `;

            await carregarConfigs();

        }

        async function carregarConfigs() {

            const btn = document.getElementById("btnConsultar");
            btn.innerHTML = `<span class="spinner"></span> Carregando Produtos...`;
            btn.disabled = true;

            const req = await fetch("/api/v8/configs");
            const data = await req.json();

            btn.innerHTML = `<i class="fa fa-search"></i> Consultar Situação / Margem`;
            btn.disabled = false;

            if (!data.configs) {
                document.getElementById("lista-configs").innerHTML =
                    `<div class="resultado">Nenhum produto encontrado.</div>`;
                return;
            }

            let html = "";
            data.configs.forEach(cfg => {

                window.v8Config = cfg;

                html += `
        <div class="config-card" onclick='selecionarConfig(${JSON.stringify(cfg)})'>
            <div class="config-title">${cfg.slug}</div>
            <div>Taxa Mensal: <b>${(Number(cfg.monthly_interest_rate) * 100).toFixed(2).replace('.', ',')}%</b></div>
            <div>Parcelas: <b>${cfg.number_of_installments.join(", ")}</b></div>
        </div>
        `;
            });

            document.getElementById("lista-configs").innerHTML = html;
            document.getElementById("card-configs").style.display = "block";
        }

        function selecionarConfig(cfg) {
            window.v8Config = cfg;

            document.querySelectorAll(".config-card").forEach(c => {
                c.classList.remove("selected");
            });

            event.currentTarget.classList.add("selected");

            document.getElementById("card-simulacao").style.display = "block";

            console.log("Config selecionada:", cfg.slug);
        }


        async function simular() {
            const btn = document.getElementById("btnSimular");
            btn.innerHTML = `<span class="spinner"></span> Simulando...`;
            btn.classList.add("btn-loading");

            const payload = {
                consult_id: window.v8ConsultID,
                config_id: window.v8Config.id,
                installment_face_value: Number(
                    document.getElementById("parcela").value.replace(",", ".")),
                number_of_installments: Number(document.getElementById("numParcelas").value),
                provider: "QI"
            };

            const req = await fetch("/api/v8/simular", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const d = await req.json();

            btn.innerHTML = `<i class="fa fa-calculator"></i> Simular`;
            btn.classList.remove("btn-loading");

            if (d.type === "simulation_consult_not_finished") {
                alert("Consulta ainda não finalizada. Clique novamente em Consultar Situação.");
                return;
            }

            window.v8SimulationID = d.id_simulation;

            const fmt = v => Number(v).toLocaleString("pt-BR", {
                style: "currency",
                currency: "BRL"
            });

            document.getElementById("resultado-simulacao").innerHTML = `
        <div class="resultado">
            <div class="simulacao-item"><b>Parcela:</b> ${fmt(d.installment_value)}</div>
            <div class="simulacao-item"><b>Total:</b> ${fmt(d.operation_amount)}</div>
            <div class="simulacao-item"><b>Liberado:</b> ${fmt(d.disbursement_amount)}</div>
        </div>
    `;

            document.getElementById("card-proposta").style.display = "block";
        }

        async function criarProposta() {
            const btn = document.getElementById("btnProposta");

            btn.innerHTML = `<span class="spinner"></span> Criando...`;
            btn.classList.add("btn-loading");
            btn.disabled = true;

            const cpf = document.getElementById("cpf").value.replace(/\D/g, "");
            const tel = document.getElementById("telefone").value.replace(/\D/g, "");

            const payload = {
                borrower: {
                    name: document.getElementById("nome").value,
                    email: document.getElementById("email").value,
                    phone: {
                        area_code: tel.slice(0, 2),
                        country_code: "55",
                        number: tel.slice(2)
                    },
                    political_exposition: false,
                    address: {
                        city: document.getElementById("city").value,
                        state: document.getElementById("state").value,
                        number: document.getElementById("number").value,
                        street: document.getElementById("street").value,
                        complement: "",
                        postal_code: document.getElementById("postal_code").value,
                        neighborhood: document.getElementById("neighborhood").value
                    },
                    birth_date: document.getElementById("nasc").value,
                    mother_name: document.getElementById("mother_name").value,
                    nationality: document.getElementById("nationality").value,
                    document_issuer: document.getElementById("document_issuer").value,
                    gender: document.getElementById("sexo").value,
                    person_type: "natural",
                    marital_status: document.getElementById("marital_status").value,
                    individual_document_number: cpf,
                    document_identification_date: document.getElementById("nasc").value,
                    document_identification_type: document.getElementById("document_type").value,
                    document_identification_number: document.getElementById("document_number").value,
                    bank: {
                        transfer_method: "pix",
                        pix_key: document.getElementById("pix_key").value,
                        pix_key_type: "cpf"
                    }
                },
                simulation_id: window.v8SimulationID,
                provider: "QI"
            };

            const req = await fetch("/api/v8/proposta", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await req.json();

            btn.innerHTML = `<i class="fa fa-check-circle"></i> Criar Proposta`;
            btn.classList.remove("btn-loading");
            btn.disabled = false;

            if (data.formalization_url) {
                document.getElementById("resultado-proposta").innerHTML = `
            <div class="resultado">
                <b>Proposta criada!</b><br>
                <a href="${data.formalization_url}" target="_blank">Abrir Formalização</a>
            </div>
        `;
            } else {
                document.getElementById("resultado-proposta").innerHTML = `
            <div class="resultado">Erro: ${JSON.stringify(data)}</div>
        `;
            }
        }

        function limparNumero(valor) {
            return valor.replace(/\D/g, "");
        }

        function formatarCPF(cpf) {
            cpf = limparNumero(cpf).slice(0, 11);
            return cpf
                .replace(/(\d{3})(\d)/, "$1.$2")
                .replace(/(\d{3})(\d)/, "$1.$2")
                .replace(/(\d{3})(\d{1,2})$/, "$1-$2");
        }

        function formatarTelefone(tel) {
            tel = limparNumero(tel).slice(0, 11);
            return tel
                .replace(/(\d{2})(\d)/, "($1) $2")
                .replace(/(\d{5})(\d)/, "$1-$2");
        }

    </script>

</body>

</html>