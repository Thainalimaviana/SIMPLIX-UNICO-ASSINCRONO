<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Fila Simplix - FGTS</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tomorrow&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Creepster&display=swap" rel="stylesheet">
</head>

<body class="pagina">
    <button class="menu-toggle" id="menuToggle"><i class="fa fa-bars"></i></button>

    <div class="sidebar" id="sidebar">
        <div>
            <div class="logo">SIMPLIX üéÉ</div>
            <div class="user-info">
                <h3>{{ session["user"] }}</h3>
                <span>{{ session["role"] }}</span>
            </div>
            <ul class="menu">
                <li><a href="/index">‚ñ∏ Dashboard</a></li>
                <li><a href="/cadastrar">‚ñ∏ Cadastrar Cliente</a></li>
                <li><a href="/esteira">‚ñ∏ Esteira</a></li>
                {% if session['role'] == 'admin' %}
                <li><a href="/usuarios">‚ñ∏ Gerenciar Usu√°rios</a></li>
                <li><a href="/register">‚ñ∏ Criar Usu√°rio</a></li>
                {% endif %}
            </ul>
        </div>
        <div class="menu-footer">
            <button id="toggle-theme"><i class="fa fa-moon"></i> Tema</button>
            <a href="/logout" class="logout">‚ñ∏ Sair</a>
        </div>
    </div>

    <div class="content">
        <h1 class="titulo-tomorrow">Fila Simplix - FGTS üëª</h1>

        <div class="container">
            <form id="form-consulta">
                <div class="input-wrapper">
                    <input type="text" id="cpf" name="cpf" class="barra-cpf" placeholder="Digite o CPF" required>
                    <span id="loading" class="loading-spinner"></span>
                </div>

                <div class="button-group">
                    <button class="azul" type="submit"><i class="fa fa-play"></i> Enviar para Fila</button>
                    <button id="btn-limpar" class="vermelho" type="button"><i class="fa fa-trash"></i> Limpar</button>
                </div>
            </form>

            <div id="mensagem-status" style="margin-top:15px;font-weight:600;"></div>

            <div class="resultado" id="fila-container">
                <h3>üìã Fila de Consultas</h3>
                <div class="area-tabelas" id="lista-fila"></div>
            </div>
        </div>
    </div>

    <script>
        const menuToggle = document.getElementById("menuToggle");
        const sidebar = document.getElementById("sidebar");
        const content = document.querySelector(".content");

        menuToggle.addEventListener("click", () => {
            sidebar.classList.toggle("active");
            content.classList.toggle("active");
            menuToggle.classList.toggle("mover");
        });

        const toggleTheme = document.getElementById("toggle-theme");
        toggleTheme.addEventListener("click", () => {
            document.body.classList.toggle("dark-mode");
            const icon = toggleTheme.querySelector("i");
            icon.classList.toggle("fa-moon");
            icon.classList.toggle("fa-sun");
        });

        const form = document.getElementById("form-consulta");
        const spinner = document.getElementById("loading");
        const mensagemStatus = document.getElementById("mensagem-status");
        const listaFila = document.getElementById("lista-fila");

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const cpf = document.getElementById("cpf").value.replace(/\D/g, "");
            if (!cpf) return alert("Digite um CPF v√°lido!");
            spinner.style.display = "inline-block";

            try {
                const res = await fetch("/simplix-passo12", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ cpf })
                });
                const data = await res.json();

                if (res.ok) {
                    mensagemStatus.textContent = `‚úÖ CPF ${cpf} adicionado √† fila (Transaction ID: ${data.transactionId})`;
                    carregarFila();
                } else {
                    mensagemStatus.textContent = `‚ùå Erro: ${data.mensagem || data.erro || 'Falha ao adicionar √† fila.'}`;
                }
            } catch (err) {
                mensagemStatus.textContent = "Erro de conex√£o com o servidor.";
            } finally {
                spinner.style.display = "none";
            }
        });

        async function carregarFila() {
            try {
                const res = await fetch("/fila?pagina=1");
                const html = await res.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");
                const tabela = doc.querySelector("table") || doc.querySelector("#fila-tabela");
                listaFila.innerHTML = tabela ? tabela.outerHTML : "Nenhum item na fila.";
            } catch (err) {
                listaFila.innerHTML = "Erro ao carregar fila.";
            }
        }

        setInterval(carregarFila, 10000);
        window.onload = carregarFila;

        document.getElementById("btn-limpar").addEventListener("click", () => {
            document.getElementById("cpf").value = "";
            mensagemStatus.textContent = "";
        });
    </script>
    <script>
        window.excluirDaFila = function (transactionId) {
            console.log("üß® Clicado:", transactionId);

            const botao = document.querySelector(`button[onclick="excluirDaFila('${transactionId}')"]`);
            const linha = botao ? botao.closest("tr") : null;
            if (linha) linha.remove();

            fetch(`/excluir-fila/${transactionId}`, { method: "POST" })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        console.log(`üóëÔ∏è Registro ${transactionId} removido da fila.`);
                    } else {
                        console.warn(`‚ö†Ô∏è Erro ao excluir: ${data.erro || "Erro desconhecido"}`);
                    }
                })
                .catch(err => console.error("‚ùå Erro ao excluir:", err));
        };
    </script>

</body>

</html>